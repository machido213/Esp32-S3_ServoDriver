<!DOCTYPE html>
<html lang='zh-TW'>
<head>
    <meta charset='UTF-8'>
    <!-- è®“ç¶²é åœ¨æ‰‹æ©Ÿèˆ‡é›»è…¦ä¸Šéƒ½èƒ½è‡ªå‹•é©æ‡‰å¯¬åº¦ -->
    <meta name='viewport' content='width=device-width, initial-scale=1.0'>
    <title>ESP32-S3 Servo Dashboard</title>
    <style>
        /* --- å…¨å±€æ¨£å¼ï¼šæš—é»‘å·¥æ¥­é¢¨ --- */
        body { background-color: #121212; color: #e0e0e0; font-family: 'Segoe UI', sans-serif; margin: 0; padding: 20px; text-align: center; }
        h2 { color: #00bfff; margin-bottom: 5px; letter-spacing: 1px; }
        h4 { color: #aaa; margin-top: 0; margin-bottom: 20px; font-weight: normal; }
        
        /* Dashboard å®¹å™¨ (Flexbox æ’ç‰ˆï¼šè‡ªå‹•æ›è¡Œ) */
        .dashboard { display: flex; flex-wrap: wrap; justify-content: center; gap: 20px; max-width: 1600px; margin: auto; }
        
        /* å¡ç‰‡é€šç”¨æ¨£å¼ */
        .card { background: #1e1e1e; padding: 15px; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.5); border: 1px solid #333; text-align: left; }
        .card-header { border-bottom: 1px solid #333; padding-bottom: 8px; margin-bottom: 10px; font-weight: bold; color: #00bfff; display: flex; justify-content: space-between; align-items: center; }
        
        .sys-card { flex: 1 1 350px; display: flex; flex-direction: column; gap: 10px; min-width: 300px; }
        .control-row { display: flex; align-items: center; justify-content: space-between; background: #252525; padding: 10px; border-radius: 5px; margin-bottom: 2px; }
        
        /* æŒ‡ç¤ºç‡ˆæ¨£å¼ */
        .indicator { display: inline-block; width: 12px; height: 12px; border-radius: 50%; background: #444; border: 2px solid #555; margin-right: 5px; vertical-align: middle; }
        .indicator.on { background: #00ff00; box-shadow: 0 0 8px #00ff00; border-color: #fff; } /* äº®ç¶ ç‡ˆ */
        .indicator.alert { background: #ff0000; box-shadow: 0 0 8px #ff0000; border-color: #fff; } /* äº®ç´…ç‡ˆ */
        
        /* æŒ‰éˆ•åŸºç¤æ¨£å¼ */
        button { padding: 6px 12px; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; color: #bbb; background: #333; transition: 0.2s; font-size: 12px; }
        button:hover { opacity: 0.8; filter: brightness(1.2); }
        button:active { transform: scale(0.98); }

        /* ç‹€æ…‹æ¿€æ´»æ¨£å¼ (æŒ‰éˆ•è¢«å•Ÿç”¨æ™‚è®Šè‰²) */
        .btn-active-blue { background: #2196F3; color: white; box-shadow: 0 0 8px #2196F3; }
        .btn-active-red { background: #f44336; color: white; box-shadow: 0 0 8px #f44336; }
        .btn-active-green { background: #4CAF50; color: white; box-shadow: 0 0 8px #4CAF50; }
        
        /* åŠŸèƒ½æŒ‰éˆ•é¡è‰²å®šç¾© */
        .btn-green { background: #4CAF50; width: 100%; font-size: 14px; padding: 10px; margin-top: 5px; color: white; }
        .btn-purple { background: #9C27B0; width: 100%; margin-top: 5px; color: white; }
        .btn-orange { background: #ff9800; color: #000; width: 100%; margin-top: 10px; }
        .btn-fill { background: #444; color: #bbb; font-size: 10px; padding: 4px 8px; }

        /* è¼¸å…¥æ¡†æ¨£å¼ */
        input[type=range] { width: 120px; vertical-align: middle; cursor: pointer; }
        input[type=text], input[type=number], input[type=password], select { 
            background: #333; border: 1px solid #444; color: #fff; padding: 5px; border-radius: 3px; text-align: center;
            width: 100%; box-sizing: border-box; min-width: 0;
        }
        input[type=text], input[type=password] { text-align: left; }

        /* é¦¬é”å¡ç‰‡ Grid (è‡ªå‹•é©æ‡‰å¯¬åº¦) */
        .motor-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 10px; width: 100%; margin-top: 20px; }
        .motor-card { background: #1e1e1e; padding: 10px; border: 1px solid #333; border-radius: 5px; display: flex; flex-direction: column; gap: 6px; }
        .motor-status { font-size: 10px; padding: 2px 6px; border-radius: 3px; background: #333; color: #bbb; }
        .motor-status.running { background: #4CAF50; color: #fff; box-shadow: 0 0 5px #4CAF50; }

        /* é»å‹•æŒ‰éˆ•ç¾¤çµ„ */
        .jog-group { display: flex; gap: 5px; margin-top: 5px; }
        .btn-jog { flex: 1; padding: 10px; font-size: 14px; background: #37474F; border: 1px solid #555; color: white; user-select: none; -webkit-user-select: none; }
        .btn-jog:active { background: #00bfff; border-color: #00bfff; }

        /* JSON é™¤éŒ¯å€èˆ‡ç¶²è·¯æ¨™ç±¤ */
        .json-input { width: 100%; background: #111; color: #0f0; border: 1px solid #444; padding: 5px; font-family: monospace; font-size: 11px; box-sizing: border-box; }
        .net-label { font-size: 11px; color: #aaa; margin-bottom: 2px; display: block; text-align: left; }
    </style>
</head>
<body>
    <h2>âš™ï¸ ESP32-S3 å·¥æ§å„€è¡¨æ¿</h2>
    <h4 id="sys-title">System Status: Loading...</h4>
    
    <div class='dashboard'>
        <!-- å¡ç‰‡1ï¼šç‹€æ…‹ç›£æ§ -->
        <div class='card sys-card'>
            <div class='card-header'>ğŸ“¡ ç‹€æ…‹ç›£æ§</div>
            <div class='control-row'>
                <label>ğŸ”´ åœæ­¢æŒ‰éˆ• (NC)</label>
                <div><span id='led_stop' class='indicator'></span> <span id='txt_stop' style="font-size:12px; color:#888">--</span></div>
            </div>
            <div class='control-row'>
                <label>ğŸŸ¢ æ¥è§¸å™¨å›é¥‹ (NO)</label>
                <div><span id='led_feedback' class='indicator'></span> <span id='txt_feedback' style="font-size:12px; color:#888">--</span></div>
            </div>
            <div class='control-row'>
                <label>ğŸŒ¡ï¸ æ©Ÿç®±æº«åº¦</label>
                <span style="color:#00bfff; font-weight:bold; font-size:18px"><span id='val_temp'>--</span> Â°C</span>
            </div>
            <div class='control-row'>
                <label>ğŸŒ€ æ•£ç†±é¢¨æ‰‡</label>
                <div style="display:flex; align-items:center; gap:5px;">
                    <input type="range" id="fan_slider" min="0" max="255" value="0" onchange="c('/api/fan?val='+this.value)" oninput="document.getElementById('txt_fan').innerText=this.value">
                    <span id="txt_fan" style="font-size:11px; color:#aaa; width:25px; text-align:right;">0</span>
                </div>
            </div>
        </div>

        <!-- å¡ç‰‡2ï¼šé ç«¯æ“ä½œ & ç¶²è·¯è¨­å®š -->
        <div class='card sys-card'>
            <div class='card-header'>ğŸ® é ç«¯æ“ä½œ</div>
            <div class='control-row'>
                <label>ç³»çµ±é›»æº</label>
                <div>
                    <button id="btn_start" onclick="c('/api/relay?type=start&state=1')">å•Ÿå‹•</button>
                    <button id="btn_stop" onclick="c('/api/relay?type=cutoff&state=1')">æ–·é›»</button>
                </div>
            </div>
            <div class='control-row'>
                <label>ä¼ºæœå§‹èƒ½</label>
                <div>
                    <button id="btn_sv_on" onclick="c('/api/relay?type=enable&state=1')">ON</button>
                    <button id="btn_sv_off" onclick="c('/api/relay?type=enable&state=0')">OFF</button>
                </div>
            </div>
            <hr style="border-color:#333; margin:10px 0; opacity:0.5;">
            <div class='card-header' style="border:none; margin-bottom:0; font-size:14px;">ğŸ“¶ ç¶²è·¯è¨­å®š</div>
            <div style="padding:5px; background:#252525; border-radius:5px;">
                <div style="margin-bottom:5px;">
                    <span class="net-label">WiFi SSID / Password</span>
                    <div style="display:flex; gap:5px;">
                        <input type="text" id="cfg_ssid" placeholder="SSID">
                        <input type="password" id="cfg_pass" placeholder="Password">
                    </div>
                </div>
                <div>
                    <span class="net-label">Static IP / Gateway</span>
                    <div style="display:flex; gap:5px;">
                        <input type="text" id="cfg_ip" placeholder="192.168.x.x">
                        <input type="text" id="cfg_gw" placeholder="192.168.x.1">
                    </div>
                </div>
                <button class="btn-orange" onclick="saveWifi()">ğŸ’¾ å„²å­˜ä¸¦é‡å•Ÿ</button>
            </div>
        </div>

        <!-- å¡ç‰‡3ï¼šOTA æ›´æ–° -->
        <div class='card sys-card'>
            <div class='card-header'>ğŸš€ OTA éŸŒé«”æ›´æ–°</div>
            <div style="background:#252525; padding:10px; border-radius:5px;">
                <div style="margin-bottom:5px; font-size:11px; color:#aaa">éŸŒé«”ä¾†æºç¶²å€ (.bin):</div>
                <input type='text' id='ota_url' value='https://github.com/machido213/Esp32-S3_ServoDriver/releases/latest/download/Esp32-S3_ServoDriver.bin'>
                <div style="margin-top:8px; display:flex; gap:10px; justify-content:center;">
                    <button class='btn-fill' onclick="fillGithub()">GitHub</button>
                    <button class='btn-fill' onclick="fillLocal()">Local</button>
                </div>
                <button class='btn-purple' onclick='startOTA()'>ç«‹å³é–‹å§‹æ›´æ–°</button>
                <div id='ota_status' style='font-size:11px; color:#bbb; margin-top:5px; text-align:center; font-weight:bold; height:15px;'></div>
            </div>
        </div>
        
        <!-- åº•éƒ¨ï¼šJSON ç‹€æ…‹é¡¯ç¤º -->
        <div class='card' style="flex: 1 1 100%; max-width: 100%;">
            <input type="text" id="json_output" class="json-input" readonly>
        </div>
    </div>

    <!-- é¦¬é”æ§åˆ¶å€ (7è»¸) -->
    <div class='motor-grid' id='motor_container'></div>

    <script>
        const GITHUB_URL = "https://github.com/machido213/Esp32-S3_ServoDriver/releases/latest/download/Esp32-S3_ServoDriver.bin";
        const LOCAL_URL  = "http://192.168.2.100:8000/Esp32-S3_ServoDriver.bin";
        const AXIS_COUNT = 7;

        // ## é»å‹•é–ï¼šé¿å…æ»‘é¼ æ»‘éæ™‚èª¤è§¸ç™¼åœæ­¢
        let activeJogAxis = -1;

        // å‹•æ…‹ç”Ÿæˆ 7 å€‹é¦¬é”çš„å¡ç‰‡
        let html = '';
        for(let i=0; i<AXIS_COUNT; i++) {
            html += `
            <div class='motor-card'>
                <div class="motor-header">
                    <span style="color:#00bfff; font-weight:bold">Axis ${i+1}</span>
                    <span id='tag_${i}' class='motor-status'>IDLE</span>
                </div>
                
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:5px;">
                    <div>
                        <label style="font-size:10px; color:#aaa; display:block">Steps</label>
                        <input type='number' id='s_${i}' value='1000'>
                    </div>
                    <div>
                        <label style="font-size:10px; color:#aaa; display:block">Hz</label>
                        <input type='number' id='f_${i}' value='1000'>
                    </div>
                </div>

                <div style="display:flex; gap:5px; margin-top:2px;">
                    <select id='d_${i}' style="flex:2"><option value='1'>CW (æ­£è½‰)</option><option value='0'>CCW (åè½‰)</option></select>
                    <button class='btn-active-red' style="flex:1" onclick="c('/api/motor/stop?axis=${i}')">â– </button>
                </div>
                
                <button class='btn-green' onclick='runMotor(${i})'>RUN</button>

                <div class="jog-group">
                    <!-- é»å‹•æŒ‰éˆ•ï¼šç¶å®šå¤šç¨®äº‹ä»¶ä»¥æ”¯æ´æ»‘é¼ èˆ‡è§¸æ§ -->
                    <button class="btn-jog" 
                        onmousedown="jogStart(event, ${i}, 1)" 
                        ontouchstart="jogStart(event, ${i}, 1)" 
                        
                        onmouseup="jogStop(event, ${i})" 
                        onmouseleave="jogStop(event, ${i})"
                        ontouchend="jogStop(event, ${i})" 
                        ontouchcancel="jogStop(event, ${i})"
                        oncontextmenu="return false;"
                    >â—€</button>
                    
                    <button class="btn-jog" 
                        onmousedown="jogStart(event, ${i}, 0)" 
                        ontouchstart="jogStart(event, ${i}, 0)" 
                        
                        onmouseup="jogStop(event, ${i})" 
                        onmouseleave="jogStop(event, ${i})"
                        ontouchend="jogStop(event, ${i})" 
                        ontouchcancel="jogStop(event, ${i})"
                        oncontextmenu="return false;"
                    >â–¶</button>
                </div>
            </div>`;
        }
        document.getElementById('motor_container').innerHTML = html;

        // ç°¡åŒ– fetch å‘¼å«
        function c(u){ fetch(u, {method:'POST'}).catch(e=>{}); }
        
        function runMotor(i) {
            let s = document.getElementById(`s_${i}`).value;
            let f = document.getElementById(`f_${i}`).value;
            let d = document.getElementById(`d_${i}`).value;
            c(`/api/motor?axis=${i}&steps=${s}&freq=${f}&dir=${d}`);
        }

        // ## é»å‹•é‚è¼¯ï¼šæŒ‰ä¸‹ç™¼é€ç„¡é™æ­¥æ•¸ï¼Œæ”¾é–‹/é›¢é–‹æ™‚ç™¼é€åœæ­¢
        function jogStart(e, i, dir) {
            if(e) { e.preventDefault(); e.stopPropagation(); } 
            
            if (activeJogAxis !== -1) return; // å·²ç¶“æœ‰åˆ¥è»¸åœ¨å‹•ï¼Œå¿½ç•¥

            activeJogAxis = i; 
            let f = document.getElementById(`f_${i}`).value;
            // 999999 ä»£è¡¨ç„¡é™è·‘
            c(`/api/motor?axis=${i}&steps=999999&freq=${f}&dir=${dir}`);
        }

        function jogStop(e, i) {
            if(e) e.preventDefault();

            // åªæœ‰ç•¶ã€Œç›®å‰æ­£åœ¨å‹•çš„è»¸ã€ç­‰æ–¼ã€Œäº‹ä»¶è§¸ç™¼è»¸ã€æ™‚æ‰åœæ­¢ï¼Œé¿å…èª¤è§¸
            if (activeJogAxis === i) {
                c(`/api/motor/stop?axis=${i}`);
                activeJogAxis = -1; 
            }
        }

        function saveWifi() {
            if(!confirm("ç¢ºå®šè¦ä¿®æ”¹ç¶²è·¯è¨­å®šä¸¦é‡å•Ÿå—ï¼Ÿ\nè«‹ç¢ºèªå¯†ç¢¼æ­£ç¢ºï¼Œå¦å‰‡éœ€é‡ç½®ï¼")) return;
            let data = {
                ssid: document.getElementById('cfg_ssid').value,
                pass: document.getElementById('cfg_pass').value,
                ip:   document.getElementById('cfg_ip').value,
                gw:   document.getElementById('cfg_gw').value
            };
            fetch('/api/save_wifi', { method: 'POST', body: JSON.stringify(data) })
            .then(r => r.text()).then(msg => alert("ESP32: " + msg))
            .catch(e => alert("Error: " + e));
        }

        function fillGithub() { document.getElementById('ota_url').value = GITHUB_URL; }
        function fillLocal() { document.getElementById('ota_url').value = LOCAL_URL; }

        function startOTA() {
            const url = document.getElementById('ota_url').value;
            if(!url) return alert('è«‹è¼¸å…¥ç¶²å€');
            
            document.getElementById('ota_status').innerText = 'â³ ä¸‹è¼‰æ›´æ–°ä¸­...';
            document.getElementById('ota_status').style.color = '#00bfff';
            
            fetch('/ota', { method: 'POST', body: JSON.stringify({url: url}) })
            .then(r => r.text())
            .then(t => {
                document.getElementById('ota_status').innerText = 'Response: ' + t;
                document.getElementById('ota_status').style.color = '#4CAF50';
            })
            .catch(e => {
                document.getElementById('ota_status').innerText = 'Error: ' + e;
                document.getElementById('ota_status').style.color = '#f44336';
            });
        }

        // å®šæ™‚æ›´æ–°ç‹€æ…‹ (Polling)
        let firstLoad = true;
        let isEditingFan = false; 
        const fanSlider = document.getElementById('fan_slider');
        
        // é˜²æ­¢æ‹‰å‹•æ»‘æ¡¿æ™‚ä¸€ç›´è¢«å¾Œç«¯æ•¸å€¼è¦†è“‹
        fanSlider.addEventListener('mousedown', () => isEditingFan = true);
        fanSlider.addEventListener('mouseup', () => isEditingFan = false);
        fanSlider.addEventListener('touchstart', () => isEditingFan = true);
        fanSlider.addEventListener('touchend', () => isEditingFan = false);

        setInterval(() => {
            fetch('/status').then(r=>r.json()).then(d => {
                // 1. æ›´æ–° JSON é¡¯ç¤º
                document.getElementById('json_output').value = JSON.stringify(d);
                document.getElementById('sys-title').innerText = "System Status: " + (d.net ? "Online (" + d.net.ip + ")" : "Offline");
                
                // 2. æ›´æ–° IO ç‹€æ…‹ (åœæ­¢éˆ•ã€å›é¥‹)
                let ledStop = document.getElementById('led_stop');
                let txtStop = document.getElementById('txt_stop');
                // åœæ­¢æŒ‰éˆ•é€šå¸¸æ˜¯ NC (å¸¸é–‰)ï¼Œæ‰€ä»¥ 1 æ˜¯æ­£å¸¸ï¼Œ0 æ˜¯è¢«æŒ‰ä¸‹(æ–·è·¯) -> éœ€ä¾ç…§å¯¦éš›æ¥ç·šèª¿æ•´é‚è¼¯
                if (d.btn_stop == 0) { ledStop.className='indicator alert'; txtStop.innerText="PRESSED"; }
                else { ledStop.className='indicator on'; txtStop.innerText="OK"; }

                let ledFb = document.getElementById('led_feedback');
                let txtFb = document.getElementById('txt_feedback');
                if (d.feedback == 1) { ledFb.className='indicator on'; txtFb.innerText="ACTIVE"; }
                else { ledFb.className='indicator'; txtFb.innerText="OFF"; }

                document.getElementById('val_temp').innerText = d.temp.toFixed(1);

                // 3. æ›´æ–°æŒ‰éˆ•æ¨£å¼ï¼šå¦‚æœé–‹å•Ÿå°±è®Šæˆå½©è‰²ï¼Œé—œé–‰å°±è®Šå›ç°è‰²
                document.getElementById('btn_start').className = d.power_on ? 'btn-active-blue' : '';
                document.getElementById('btn_stop').className = !d.power_on ? 'btn-active-red' : '';
                document.getElementById('btn_sv_on').className = d.servo_on ? 'btn-active-green' : '';
                document.getElementById('btn_sv_off').className = !d.servo_on ? '' : ''; 

                // 4. æ›´æ–°é¢¨æ‰‡ (å¦‚æœæ²’åœ¨æ‹‰å‹•)
                if (!isEditingFan) {
                    document.getElementById('fan_slider').value = d.fan;
                    document.getElementById('txt_fan').innerText = d.fan;
                }

                // 5. æ›´æ–°é¦¬é”ç‹€æ…‹
                if(d.motors) {
                    d.motors.forEach((m, i) => {
                        let tag = document.getElementById(`tag_${i}`);
                        if(tag) {
                            tag.className = m.run ? 'motor-status running' : 'motor-status';
                            tag.innerText = m.run ? 'RUNNING' : 'IDLE';
                        }
                    });
                }
                
                // 6. ç¬¬ä¸€æ¬¡è¼‰å…¥æ™‚ï¼Œè‡ªå‹•å¡«å…¥ç•¶å‰çš„ WiFi è¨­å®š
                if(firstLoad && d.net) {
                    document.getElementById('cfg_ssid').value = d.net.ssid || '';
                    document.getElementById('cfg_ip').value = d.net.ip || '';
                    document.getElementById('cfg_gw').value = d.net.gw || '';
                    firstLoad = false;
                }
            }).catch(e => {
                // é€£ç·šå¤±æ•—æ™‚ä¸å ±éŒ¯
            });
        }, 300); // æ¯ 300ms æ›´æ–°ä¸€æ¬¡
    </script>
</body>
</html>