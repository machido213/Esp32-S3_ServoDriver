<!DOCTYPE html>
<html lang='zh-TW'>
<head>
    <meta charset='UTF-8'>
    <meta name='viewport' content='width=device-width, initial-scale=1.0'>
    <title>ESP32-S3 Servo Dashboard</title>
    <style>
        /* å…¨å±€æ¨£å¼ï¼šæš—é»‘å·¥æ¥­é¢¨ */
        body { background-color: #121212; color: #e0e0e0; font-family: 'Segoe UI', sans-serif; margin: 0; padding: 20px; text-align: center; }
        h2 { color: #00bfff; margin-bottom: 20px; letter-spacing: 1px; }
        
        /* å®¹å™¨æ’ç‰ˆ */
        .dashboard { display: flex; flex-wrap: wrap; justify-content: center; gap: 20px; max-width: 1400px; margin: auto; }
        
        /* å¡ç‰‡é€šç”¨æ¨£å¼ */
        .card { background: #1e1e1e; padding: 15px; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.5); border: 1px solid #333; text-align: left; }
        .card-header { border-bottom: 1px solid #333; padding-bottom: 8px; margin-bottom: 10px; font-weight: bold; color: #00bfff; display: flex; justify-content: space-between; align-items: center; }
        
        /* ç³»çµ±æ§åˆ¶å€ */
        .sys-card { flex: 1 1 350px; display: flex; flex-direction: column; gap: 10px; }
        .control-row { display: flex; align-items: center; justify-content: space-between; background: #252525; padding: 10px; border-radius: 5px; margin-bottom: 5px; }
        
        /* ç‡ˆè™Ÿ */
        .indicator { display: inline-block; width: 12px; height: 12px; border-radius: 50%; background: #444; border: 2px solid #555; margin-right: 5px; }
        .indicator.on { background: #00ff00; box-shadow: 0 0 8px #00ff00; }
        .indicator.off { background: #555; }
        .indicator.alert { background: #ff0000; box-shadow: 0 0 8px #ff0000; }
        
        /* æŒ‰éˆ•å„ªåŒ– */
        button { padding: 8px 12px; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; color: white; transition: 0.2s; font-size: 13px; }
        button:hover { opacity: 0.8; filter: brightness(1.2); }
        button:active { transform: scale(0.98); }

        .btn-start { background: #2196F3; }
        .btn-stop { background: #f44336; }
        .btn-run { background: #4CAF50; width: 100%; margin-top:5px; padding: 10px; font-size: 14px;}
        .btn-ota { background: #9C27B0; width: 100%; margin-top: 5px; }
        .btn-fill { background: #444; color: #bbb; font-size: 11px; padding: 5px 10px; }

        /* é»å‹•æŒ‰éˆ•ç¾¤çµ„ */
        .jog-group { display: flex; gap: 5px; margin-top: 5px; }
        .btn-jog { flex: 1; padding: 10px; font-size: 14px; background: #37474F; border: 1px solid #555; }
        .btn-jog:active { background: #00bfff; border-color: #00bfff; }

        /* è¼¸å…¥æ¡†ä¿®å¾©ï¼šç¢ºä¿åœ¨ Grid å…§ä¸ç©¿æ¨¡ */
        input[type=range] { width: 100px; vertical-align: middle; }
        input[type=text], input[type=number], select { 
            background: #333; border: 1px solid #444; color: #fff; padding: 6px; border-radius: 3px; text-align: center;
            width: 100%;             /* å¼·åˆ¶å¡«æ»¿å®¹å™¨ */
            box-sizing: border-box;  /* è®“ padding ä¸æœƒæ’å¤§å¯¬åº¦ */
            min-width: 0;            /* é˜²æ­¢ Grid æº¢å‡º */
        }

        /* é¦¬é”ç¶²æ ¼ */
        .motor-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 10px; width: 100%; margin-top: 20px; }
        .motor-card { background: #1e1e1e; padding: 15px; border: 1px solid #333; border-radius: 5px; display: flex; flex-direction: column; gap: 8px;}
        .motor-status { font-size: 10px; padding: 2px 6px; border-radius: 3px; background: #333; color: #bbb; float: right; }
        .motor-status.running { background: #4CAF50; color: #fff; }
        
        /* å–®è¡Œ JSON */
        .json-input { width: 100%; background: #111; color: #0f0; border: 1px solid #444; padding: 5px; font-family: monospace; font-size: 12px; box-sizing: border-box; }
    </style>
</head>
<body>
    <h2>âš™ï¸ ESP32-S3 å·¥æ§å„€è¡¨æ¿</h2>
    
    <div class='dashboard'>
        
        <!-- å·¦å´ï¼šç’°å¢ƒèˆ‡ IO ç›£æ§ -->
        <div class='card sys-card'>
            <div class='card-header'>ğŸ“¡ ç‹€æ…‹ç›£æ§ (Input Monitor)</div>
            
            <div class='control-row'>
                <span>ğŸ”´ åœæ­¢æŒ‰éˆ• (NC)</span>
                <div><span id='led_stop' class='indicator'></span> <span id='txt_stop' style="font-size:12px; color:#888">--</span></div>
            </div>
            <div class='control-row'>
                <span>ğŸŸ¢ æ¥è§¸å™¨å›é¥‹ (NO)</span>
                <div><span id='led_feedback' class='indicator'></span> <span id='txt_feedback' style="font-size:12px; color:#888">--</span></div>
            </div>
            <div class='control-row'>
                <span>ğŸŒ¡ï¸ æ©Ÿç®±æº«åº¦</span>
                <span style="color:#00bfff; font-weight:bold; font-size:18px"><span id='val_temp'>--</span> Â°C</span>
            </div>
            <div class='control-row'>
                <span>ğŸŒ€ æ•£ç†±é¢¨æ‰‡</span>
                <div>
                    <input type="range" min="0" max="255" value="0" onchange="c('/api/fan?val='+this.value)">
                    <span style="font-size:12px; color:#aaa">PWM</span>
                </div>
            </div>
        </div>

        <!-- ä¸­é–“ï¼šé ç«¯æ“ä½œ & OTA -->
        <div class='card sys-card'>
            <div class='card-header'>ğŸ® é ç«¯æ“ä½œ (Remote Control)</div>
            
            <div class='control-row'>
                <span>ç³»çµ±é›»æº</span>
                <div>
                    <button class='btn-start' onclick="c('/api/relay?type=start&state=1')">å•Ÿå‹•</button>
                    <button class='btn-stop' onclick="c('/api/relay?type=cutoff&state=1')">æ–·é›»</button>
                </div>
            </div>
            
            <div class='control-row'>
                <span>ä¼ºæœå§‹èƒ½</span>
                <div>
                    <button class='btn-start' style="background:#009688" onclick="c('/api/relay?type=enable&state=1')">ON</button>
                    <button class='btn-stop' style="background:#607D8B" onclick="c('/api/relay?type=enable&state=0')">OFF</button>
                </div>
            </div>

            <!-- OTA å€åŸŸ -->
            <hr style="border-color: #333; margin: 10px 0; width: 100%;">
            <div class='card-header' style="border:none; margin-bottom:0">ğŸš€ OTA éŸŒé«”æ›´æ–°</div>
            
            <div style="background:#252525; padding:10px; border-radius:5px;">
                <div style="margin-bottom:5px; font-size:12px; color:#aaa">éŸŒé«”ä¾†æºç¶²å€ (.bin):</div>
                <input type='text' id='ota_url' value='https://github.com/machido213/Esp32-S3_ServoDriver/releases/latest/download/Esp32-S3_ServoDriver.bin'>
                
                <div style="margin-top:8px; display:flex; gap:10px; justify-content:center;">
                    <button class='btn-fill' onclick="fillGithub()">GitHub (Latest)</button>
                    <button class='btn-fill' onclick="fillLocal()">Local (Python)</button>
                </div>

                <button class='btn-ota' onclick='startOTA()'>ç«‹å³é–‹å§‹æ›´æ–°</button>
                <div id='ota_status' style='font-size:12px; color:#bbb; margin-top:5px; text-align:center; font-weight:bold;'></div>
            </div>
        </div>

        <!-- å³å´ï¼šJSON æ•¸æ“š -->
        <div class='card' style="flex: 1 1 100%; max-width: 100%;">
            <div style="font-size:12px; color:#aaa; margin-bottom:5px">System Raw Data (JSON)</div>
            <input type="text" id="json_output" class="json-input" readonly>
        </div>
    </div>

    <!-- ä¸‹æ–¹ï¼š7 è»¸é¦¬é”æ§åˆ¶ -->
    <div class='motor-grid' id='motor_container'></div>

    <script>
        // 1. è¨­å®š OTA é è¨­ç¶²å€
        const GITHUB_URL = "https://github.com/machido213/Esp32-S3_ServoDriver/releases/latest/download/Esp32-S3_ServoDriver.bin";
        const LOCAL_URL  = "http://192.168.2.100:8000/Esp32-S3_ServoDriver.bin";

        // 2. åˆå§‹åŒ–é¦¬é”å¡ç‰‡
        const AXIS_COUNT = 7;
        let html = '';
        for(let i=0; i<AXIS_COUNT; i++) {
            html += `
            <div class='motor-card'>
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <span style="color:#00bfff; font-weight:bold">Axis ${i+1}</span>
                    <span id='tag_${i}' class='motor-status'>IDLE</span>
                </div>
                
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:8px;">
                    <div>
                        <label style="font-size:10px; color:#aaa; display:block">Steps</label>
                        <input type='number' id='s_${i}' value='1000'>
                    </div>
                    <div>
                        <label style="font-size:10px; color:#aaa; display:block">Hz</label>
                        <input type='number' id='f_${i}' value='1000'>
                    </div>
                </div>

                <div style="display:flex; gap:5px; margin-top:2px;">
                    <!-- æ–¹å‘é¸æ“‡ (ä¿ç•™çµ¦å–®æ¬¡ RUN ä½¿ç”¨) -->
                    <select id='d_${i}' style="flex:2"><option value='1'>CW (æ­£è½‰)</option><option value='0'>CCW (åè½‰)</option></select>
                    <button class='btn-stop' style="flex:1" onclick="c('/api/motor/stop?axis=${i}')">STOP</button>
                </div>
                
                <!-- å–®æ¬¡åŸ·è¡ŒæŒ‰éˆ• -->
                <button class='btn-run' onclick='runMotor(${i})'>RUN (åŸ·è¡Œè¨­å®š)</button>

                <!-- é»å‹•æŒ‰éˆ• (æŒ‰ä½ä¸æ”¾) -->
                <div class="jog-group">
                    <button class="btn-jog" 
                        onmousedown="jogStart(${i}, 1)" onmouseup="jogStop(${i})" onmouseleave="jogStop(${i})"
                        ontouchstart="jogStart(${i}, 1)" ontouchend="jogStop(${i})"
                    >â—€ æ­£è½‰</button>
                    
                    <button class="btn-jog" 
                        onmousedown="jogStart(${i}, 0)" onmouseup="jogStop(${i})" onmouseleave="jogStop(${i})"
                        ontouchstart="jogStart(${i}, 0)" ontouchend="jogStop(${i})"
                    >åè½‰ â–¶</button>
                </div>
            </div>`;
        }
        document.getElementById('motor_container').innerHTML = html;

        // 3. å‡½å¼åº«
        function c(u){ fetch(u, {method:'POST'}); }
        
        // ä¸€èˆ¬å–®æ¬¡åŸ·è¡Œ (è®€å– Select çš„æ–¹å‘)
        function runMotor(i) {
            let s = document.getElementById(`s_${i}`).value;
            let f = document.getElementById(`f_${i}`).value;
            let d = document.getElementById(`d_${i}`).value;
            c(`/api/motor?axis=${i}&steps=${s}&freq=${f}&dir=${d}`);
        }

        // é»å‹•æ§åˆ¶ï¼šæŒ‰ä¸‹é–‹å§‹
        function jogStart(i, dir) {
            // ä½¿ç”¨è¼¸å…¥æ¡†çš„ Steps å’Œ Freq (è‹¥éœ€ç„¡é™è½‰å‹•ï¼Œä½¿ç”¨è€…å¯å°‡ Steps è¨­å¾ˆå¤§)
            let s = document.getElementById(`s_${i}`).value;
            let f = document.getElementById(`f_${i}`).value;
            
            // é˜²æ­¢å› ç‚ºæŒ‰ä¸‹æ™‚è§¸ç™¼åç™½
            if(window.getSelection) window.getSelection().removeAllRanges();
            
            c(`/api/motor?axis=${i}&steps=${s}&freq=${f}&dir=${dir}`);
        }

        // é»å‹•æ§åˆ¶ï¼šæ”¾é–‹åœæ­¢
        function jogStop(i) {
            c(`/api/motor/stop?axis=${i}`);
        }

        // å¿«é€Ÿå¡«å…¥ç¶²å€
        function fillGithub() { document.getElementById('ota_url').value = GITHUB_URL; }
        function fillLocal() { document.getElementById('ota_url').value = LOCAL_URL; }

        function startOTA() {
            const url = document.getElementById('ota_url').value;
            if(!url) { alert('è«‹è¼¸å…¥ç¶²å€'); return; }
            if(!confirm("ç¢ºå®šè¦æ›´æ–°éŸŒé«”å—ï¼Ÿ ESP32 å°‡æœƒé‡å•Ÿã€‚")) return;

            document.getElementById('ota_status').innerText = 'â³ ä¸‹è¼‰æ›´æ–°ä¸­ï¼Œè«‹å‹¿æ–·é›»...';
            document.getElementById('ota_status').style.color = '#00bfff';
            
            fetch('/ota', {
                method: 'POST', 
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({url: url})
            })
            .then(r => r.text())
            .then(t => {
                document.getElementById('ota_status').innerText = 'System Response: ' + t;
                if(t.includes("Started")) {
                    document.getElementById('ota_status').style.color = '#4CAF50';
                } else {
                    document.getElementById('ota_status').style.color = '#f44336';
                }
            })
            .catch(e => {
                document.getElementById('ota_status').innerText = 'Error: ' + e;
                document.getElementById('ota_status').style.color = '#f44336';
            });
        }

        // 4. å®šæ™‚æ›´æ–°ç‹€æ…‹
        setInterval(() => {
            fetch('/status').then(r=>r.json()).then(d => {
                document.getElementById('json_output').value = JSON.stringify(d);
                document.getElementById('val_temp').innerText = d.temp;

                // ç‡ˆè™Ÿé‚è¼¯
                let isStopPressed = (d.btn_stop === 0);
                document.getElementById('led_stop').className = isStopPressed ? 'indicator alert' : 'indicator off';
                document.getElementById('txt_stop').innerText = isStopPressed ? 'PRESSED' : 'RELEASED';

                let isEngaged = (d.feedback === 0);
                document.getElementById('led_feedback').className = isEngaged ? 'indicator on' : 'indicator off';
                document.getElementById('txt_feedback').innerText = isEngaged ? 'ENGAGED' : 'OPEN';

                if(d.motors) {
                    d.motors.forEach((m, i) => {
                        let tag = document.getElementById(`tag_${i}`);
                        if(tag) {
                            tag.className = m.run ? 'motor-status running' : 'motor-status';
                            tag.innerText = m.run ? 'RUNNING' : 'IDLE';
                        }
                    });
                }
            });
        }, 500);
    </script>
</body>
</html>