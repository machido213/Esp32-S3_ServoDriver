<!DOCTYPE html>
<html lang='zh-TW'>
<head>
    <meta charset='UTF-8'>
    <meta name='viewport' content='width=device-width, initial-scale=1.0'>
    <title>ESP32-S3 Servo Dashboard</title>
    <style>
        /* å…¨å±€æ¨£å¼ï¼šæš—é»‘å·¥æ¥­é¢¨ */
        body { background-color: #121212; color: #e0e0e0; font-family: 'Segoe UI', sans-serif; margin: 0; padding: 20px; text-align: center; }
        h2 { color: #00bfff; margin-bottom: 20px; letter-spacing: 1px; }
        
        /* å®¹å™¨æ’ç‰ˆ */
        .dashboard { display: flex; flex-wrap: wrap; justify-content: center; gap: 20px; max-width: 1400px; margin: auto; }
        
        /* å¡ç‰‡é€šç”¨æ¨£å¼ */
        .card { background: #1e1e1e; padding: 15px; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.5); border: 1px solid #333; text-align: left; }
        .card-header { border-bottom: 1px solid #333; padding-bottom: 8px; margin-bottom: 10px; font-weight: bold; color: #00bfff; display: flex; justify-content: space-between; align-items: center; }
        
        /* ç³»çµ±æ§åˆ¶å€ */
        .sys-card { flex: 1 1 350px; display: flex; flex-direction: column; gap: 10px; }
        .control-row { display: flex; align-items: center; justify-content: space-between; background: #252525; padding: 10px; border-radius: 5px; margin-bottom: 5px; }
        
        /* ç‡ˆè™Ÿ */
        .indicator { display: inline-block; width: 12px; height: 12px; border-radius: 50%; background: #444; border: 2px solid #555; margin-right: 5px; }
        .indicator.on { background: #00ff00; box-shadow: 0 0 8px #00ff00; }
        .indicator.off { background: #555; }
        .indicator.alert { background: #ff0000; box-shadow: 0 0 8px #ff0000; }
        
        /* æŒ‰éˆ•å„ªåŒ– */
        button { padding: 8px 12px; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; color: white; transition: 0.2s; font-size: 13px; }
        button:hover { opacity: 0.8; filter: brightness(1.2); }
        button:active { transform: scale(0.98); }

        .btn-start { background: #2196F3; }
        .btn-stop { background: #f44336; }
        .btn-run { background: #4CAF50; width: 100%; margin-top:5px; padding: 10px; font-size: 14px;}
        .btn-ota { background: #9C27B0; width: 100%; margin-top: 5px; }
        .btn-save { background: #ff9800; color: #000; width: 100%; margin-top: 5px; }
        .btn-fill { background: #444; color: #bbb; font-size: 11px; padding: 5px 10px; }

        /* é»å‹•æŒ‰éˆ•ç¾¤çµ„ */
        .jog-group { display: flex; gap: 5px; margin-top: 5px; }
        .btn-jog { flex: 1; padding: 10px; font-size: 14px; background: #37474F; border: 1px solid #555; }
        .btn-jog:active { background: #00bfff; border-color: #00bfff; }

        /* è¼¸å…¥æ¡†ä¿®å¾©ï¼šç¢ºä¿åœ¨ Grid å…§ä¸ç©¿æ¨¡ */
        input[type=range] { width: 100px; vertical-align: middle; }
        input[type=text], input[type=number], input[type=password], select { 
            background: #333; border: 1px solid #444; color: #fff; padding: 6px; border-radius: 3px; text-align: center;
            width: 100%;             /* å¼·åˆ¶å¡«æ»¿å®¹å™¨ */
            box-sizing: border-box;  /* è®“ padding ä¸æœƒæ’å¤§å¯¬åº¦ */
            min-width: 0;            /* é˜²æ­¢ Grid æº¢å‡º */
        }
        input[type=text], input[type=password] { text-align: left; }

        /* é¦¬é”ç¶²æ ¼ */
        .motor-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 10px; width: 100%; margin-top: 20px; }
        .motor-card { background: #1e1e1e; padding: 15px; border: 1px solid #333; border-radius: 5px; display: flex; flex-direction: column; gap: 8px;}
        .motor-status { font-size: 10px; padding: 2px 6px; border-radius: 3px; background: #333; color: #bbb; float: right; }
        .motor-status.running { background: #4CAF50; color: #fff; }
        
        /* å–®è¡Œ JSON */
        .json-input { width: 100%; background: #111; color: #0f0; border: 1px solid #444; padding: 5px; font-family: monospace; font-size: 12px; box-sizing: border-box; }
    </style>
</head>
<body>
    <h2>âš™ï¸ ESP32-S3 å·¥æ§å„€è¡¨æ¿</h2>
    
    <div class='dashboard'>
        
        <!-- å·¦å´ï¼šç’°å¢ƒèˆ‡ IO ç›£æ§ -->
        <div class='card sys-card'>
            <div class='card-header'>ğŸ“¡ ç‹€æ…‹ç›£æ§ (Input Monitor)</div>
            
            <div class='control-row'>
                <span>ğŸ”´ åœæ­¢æŒ‰éˆ• (NC)</span>
                <div><span id='led_stop' class='indicator'></span> <span id='txt_stop' style="font-size:12px; color:#888">--</span></div>
            </div>
            <div class='control-row'>
                <span>ğŸŸ¢ æ¥è§¸å™¨å›é¥‹ (NO)</span>
                <div><span id='led_feedback' class='indicator'></span> <span id='txt_feedback' style="font-size:12px; color:#888">--</span></div>
            </div>
            <div class='control-row'>
                <span>ğŸŒ¡ï¸ æ©Ÿç®±æº«åº¦</span>
                <span style="color:#00bfff; font-weight:bold; font-size:18px"><span id='val_temp'>--</span> Â°C</span>
            </div>
        </div>

        <!-- ä¸­é–“ï¼šç¶²è·¯è¨­å®š (æ–°å¢åŠŸèƒ½) -->
        <div class='card sys-card'>
            <div class='card-header'>ğŸ“¶ ç¶²è·¯è¨­å®š (Network)</div>
            
            <div style="font-size:12px; color:#aaa; margin-bottom:5px">ä¿®æ”¹å¾Œå°‡è‡ªå‹•é‡å•Ÿ</div>
            
            <div class='control-row' style="display:block; text-align:left; padding:5px;">
                <label style="font-size:11px; color:#aaa">WiFi SSID</label>
                <input type="text" id="cfg_ssid" placeholder="WiFi åç¨±">
            </div>
            <div class='control-row' style="display:block; text-align:left; padding:5px;">
                <label style="font-size:11px; color:#aaa">WiFi Password</label>
                <input type="password" id="cfg_pass" placeholder="å¯†ç¢¼">
            </div>
            <div style="display:flex; gap:5px;">
                <div style="flex:1">
                    <label style="font-size:11px; color:#aaa">Static IP</label>
                    <input type="text" id="cfg_ip" placeholder="192.168.x.x">
                </div>
                <div style="flex:1">
                    <label style="font-size:11px; color:#aaa">Gateway</label>
                    <input type="text" id="cfg_gw" placeholder="192.168.x.1">
                </div>
            </div>

            <button class='btn-save' onclick="saveWifi()">ğŸ’¾ å„²å­˜ä¸¦é‡å•Ÿ (Save & Reboot)</button>
        </div>

        <!-- å³å´ï¼šOTA æ›´æ–° -->
        <div class='card sys-card'>
            <div class='card-header'>ğŸš€ OTA éŸŒé«”æ›´æ–°</div>
            <div style="background:#252525; padding:10px; border-radius:5px;">
                <div style="margin-bottom:5px; font-size:12px; color:#aaa">éŸŒé«”ä¾†æº (.bin):</div>
                <input type='text' id='ota_url' value='https://github.com/machido213/Esp32-S3_ServoDriver/releases/latest/download/Esp32-S3_ServoDriver.bin'>
                
                <div style="margin-top:8px; display:flex; gap:10px; justify-content:center;">
                    <button class='btn-fill' onclick="document.getElementById('ota_url').value='https://github.com/machido213/Esp32-S3_ServoDriver/releases/latest/download/Esp32-S3_ServoDriver.bin'">GitHub</button>
                    <button class='btn-fill' onclick="document.getElementById('ota_url').value='http://192.168.2.100:8000/Esp32-S3_ServoDriver.bin'">Local</button>
                </div>

                <button class='btn-ota' onclick='startOTA()'>ç«‹å³æ›´æ–°</button>
                <div id='ota_status' style='font-size:12px; color:#bbb; margin-top:5px; text-align:center;'></div>
            </div>
        </div>

        <!-- åº•éƒ¨ï¼šJSON æ•¸æ“š -->
        <div class='card' style="flex: 1 1 100%; max-width: 100%;">
            <input type="text" id="json_output" class="json-input" readonly>
        </div>
    </div>

    <!-- ä¸‹æ–¹ï¼š7 è»¸é¦¬é”æ§åˆ¶ -->
    <div class='motor-grid' id='motor_container'></div>

    <script>
        // 1. åˆå§‹åŒ–é¦¬é”å¡ç‰‡
        const AXIS_COUNT = 7;
        let html = '';
        for(let i=0; i<AXIS_COUNT; i++) {
            html += `
            <div class='motor-card'>
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <span style="color:#00bfff; font-weight:bold">Axis ${i+1}</span>
                    <span id='tag_${i}' class='motor-status'>IDLE</span>
                </div>
                
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:8px;">
                    <div>
                        <label style="font-size:10px; color:#aaa; display:block">Steps</label>
                        <input type='number' id='s_${i}' value='1000'>
                    </div>
                    <div>
                        <label style="font-size:10px; color:#aaa; display:block">Hz</label>
                        <input type='number' id='f_${i}' value='1000'>
                    </div>
                </div>

                <div style="display:flex; gap:5px; margin-top:2px;">
                    <select id='d_${i}' style="flex:2"><option value='1'>CW (æ­£è½‰)</option><option value='0'>CCW (åè½‰)</option></select>
                    <button class='btn-stop' style="flex:1" onclick="c('/api/motor/stop?axis=${i}')">â– </button>
                </div>
                
                <button class='btn-run' onclick='runMotor(${i})'>RUN (åŸ·è¡Œè¨­å®š)</button>

                <!-- é»å‹•æŒ‰éˆ• -->
                <div class="jog-group">
                    <button class="btn-jog" 
                        onmousedown="jogStart(${i}, 1)" onmouseup="jogStop(${i})" onmouseleave="jogStop(${i})"
                        ontouchstart="jogStart(${i}, 1)" ontouchend="jogStop(${i})"
                    >â—€ æ­£è½‰</button>
                    
                    <button class="btn-jog" 
                        onmousedown="jogStart(${i}, 0)" onmouseup="jogStop(${i})" onmouseleave="jogStop(${i})"
                        ontouchstart="jogStart(${i}, 0)" ontouchend="jogStop(${i})"
                    >åè½‰ â–¶</button>
                </div>
            </div>`;
        }
        document.getElementById('motor_container').innerHTML = html;

        // 2. æ ¸å¿ƒå‡½å¼
        function c(u){ fetch(u, {method:'POST'}); }
        
        function runMotor(i) {
            let s = document.getElementById(`s_${i}`).value;
            let f = document.getElementById(`f_${i}`).value;
            let d = document.getElementById(`d_${i}`).value;
            c(`/api/motor?axis=${i}&steps=${s}&freq=${f}&dir=${d}`);
        }

        // é»å‹•æ§åˆ¶
        function jogStart(i, dir) {
            let s = document.getElementById(`s_${i}`).value;
            let f = document.getElementById(`f_${i}`).value;
            if(window.getSelection) window.getSelection().removeAllRanges(); // é˜²æ­¢é¸å–æ–‡å­—
            c(`/api/motor?axis=${i}&steps=${s}&freq=${f}&dir=${dir}`);
        }
        function jogStop(i) {
            c(`/api/motor/stop?axis=${i}`);
        }

        // 3. å„²å­˜ WiFi è¨­å®š
        function saveWifi() {
            if(!confirm("ç¢ºå®šè¦ä¿®æ”¹ç¶²è·¯è¨­å®šä¸¦é‡å•Ÿå—ï¼Ÿ\nè«‹ç¢ºèªå¯†ç¢¼æ­£ç¢ºï¼Œå¦å‰‡å°‡ç„¡æ³•é€£ç·šï¼")) return;
            
            let data = {
                ssid: document.getElementById('cfg_ssid').value,
                pass: document.getElementById('cfg_pass').value,
                ip:   document.getElementById('cfg_ip').value,
                gw:   document.getElementById('cfg_gw').value
            };

            fetch('/api/save_wifi', {
                method: 'POST',
                body: JSON.stringify(data)
            }).then(r => r.text()).then(msg => {
                alert("ESP32 Response: " + msg);
            }).catch(e => alert("Error: " + e));
        }

        // 4. å®šæ™‚æ›´æ–° (Polling)
        let firstLoad = true;
        setInterval(() => {
            fetch('/status').then(r=>r.json()).then(d => {
                document.getElementById('json_output').value = JSON.stringify(d);
                document.getElementById('val_temp').innerText = d.temp;

                // IO ç‡ˆè™Ÿæ›´æ–°
                let isStopPressed = (d.btn_stop === 0);
                document.getElementById('led_stop').className = isStopPressed ? 'indicator alert' : 'indicator off';
                document.getElementById('txt_stop').innerText = isStopPressed ? 'PRESSED' : 'RELEASED';

                let isEngaged = (d.feedback === 0);
                document.getElementById('led_feedback').className = isEngaged ? 'indicator on' : 'indicator off';
                document.getElementById('txt_feedback').innerText = isEngaged ? 'ENGAGED' : 'OPEN';

                // é¦¬é”ç‹€æ…‹æ›´æ–°
                if(d.motors) {
                    d.motors.forEach((m, i) => {
                        let tag = document.getElementById(`tag_${i}`);
                        if(tag) {
                            tag.className = m.run ? 'motor-status running' : 'motor-status';
                            tag.innerText = m.run ? 'RUNNING' : 'IDLE';
                        }
                    });
                }

                // ç¬¬ä¸€æ¬¡è¼‰å…¥æ™‚ï¼ŒæŠŠç›®å‰çš„ WiFi è¨­å®šå¡«å…¥è¼¸å…¥æ¡†
                if(firstLoad && d.net) {
                    document.getElementById('cfg_ssid').value = d.net.ssid;
                    document.getElementById('cfg_ip').value = d.net.ip;
                    document.getElementById('cfg_gw').value = d.net.gw;
                    firstLoad = false;
                }
            });
        }, 1000); // 1ç§’æ›´æ–°ä¸€æ¬¡
        
        // OTA åŠŸèƒ½
        function startOTA() {
             // ... (åƒè€ƒä¸Šæ–¹èˆŠä»£ç¢¼ï¼Œé‚è¼¯ç›¸åŒ) ...
        }
    </script>
</body>
</html>