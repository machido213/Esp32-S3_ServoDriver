# 🤖 ESP32-S3 7-Axis Servo Driver & Industrial Controller

這是一個基於 **ESP32-S3 (N16R8)** 的多軸伺服馬達驅動與工控系統。專為 ROS 機器人下位機設計，具備 7 軸脈波控制、工控箱實體按鈕整合、安全互鎖邏輯以及暗黑風格的 Web 控制儀表板。

## ✨ 專案特點 (Features)

*   **核心控制**: 支援 7 軸步進/伺服馬達控制 (Pulse/Direction 模式)。
*   **Web 儀表板**: 內建暗黑工業風 Web Server，支援 RWD 響應式設計。
    *   即時監控 IO 狀態 (停止按鈕、接觸器回饋)。
    *   獨立控制每一軸 (步數、頻率、方向)。
    *   環境監控 (溫度、風扇 PWM 控制)。
    *   系統控制 (遠端啟動、強制斷電、伺服始能)。
*   **安全邏輯**:
    *   **自動始能**: 當偵測到接觸器吸合且無停止訊號時，自動開啟 Servo ON。
    *   **軟停止保護**: 按下停止鈕時，自動切斷始能並觸發斷電繼電器。
*   **OTA 更新**: 支援透過 Web 介面從 GitHub 或 Local Server 進行無線韌體更新。
*   **通訊**: 支援 USB (CDC) 與 WiFi (Static IP: `192.168.2.124`)。

## 🛠 硬體規格 (Hardware)

*   **MCU**: ESP32-S3-WROOM-1U (N16R8)
    *   **Flash**: 16MB
    *   **PSRAM**: 8MB (Octal Mode)
    *   *注意：由於使用 Octal PSRAM，GPIO 33~37 被內部佔用不可使用。*
*   **電源**: 建議外部供電 5V/3.3V (邏輯)，馬達驅動器依規格供電 (24V/48V)。
*   **連接介面**: USB Type-C (Native USB D+/D-)。

---

## 🔌 腳位定義與接線表 (Pin Map)

下表依照您的工控箱設計邏輯整理，包含了 7 軸馬達、感測器與繼電器控制。

| 主項目 | 元件 | 功能描述 | 輸入/輸出 | 數量 | GPIO | VCC | GND | 備註 |
| :--- | :--- | :--- | :---: | :---: | :---: | :---: | :---: | :--- |
| **馬達軸** | 伺服驅動器 | **Axis 1** (脈波/方向) | 輸出 | 2 | **4, 5** | - | V | 4=Pulse, 5=Dir |
| **馬達軸** | 伺服驅動器 | **Axis 2** (脈波/方向) | 輸出 | 2 | **6, 7** | - | V | 6=Pulse, 7=Dir |
| **馬達軸** | 伺服驅動器 | **Axis 3** (脈波/方向) | 輸出 | 2 | **8, 9** | - | V | 8=Pulse, 9=Dir |
| **馬達軸** | 伺服驅動器 | **Axis 4** (脈波/方向) | 輸出 | 2 | **10, 11** | - | V | 10=Pulse, 11=Dir |
| **馬達軸** | 伺服驅動器 | **Axis 5** (脈波/方向) | 輸出 | 2 | **12, 13** | - | V | 12=Pulse, 13=Dir |
| **馬達軸** | 伺服驅動器 | **Axis 6** (脈波/方向) | 輸出 | 2 | **14, 15** | - | V | 14=Pulse, 15=Dir |
| **馬達軸** | 伺服驅動器 | **Axis 7** (脈波/方向) | 輸出 | 2 | **16, 17** | - | V | 16=Pulse, 17=Dir |
| **馬達共用** | 伺服驅動器 | **Servo Enable** (始能) | 輸出 | 1 | **42** | - | V | 接至所有驅動器 SON |
| **系統控制** | 繼電器模組 | **遠端啟動觸發** | 輸出 | 1 | **38** | 5V | V | **並聯**於實體啟動鈕 (常開 NO) |
| **系統控制** | 繼電器模組 | **強制斷電觸發** | 輸出 | 1 | **39** | 5V | V | **串聯**於接觸器線圈 (常閉 NC) |
| **系統輸入** | 實體按鈕 | **停止按鈕偵測** | 輸入 | 1 | **40** | - | V | 建議使用 NC 接點 (軟體上拉) |
| **系統輸入** | 光耦模組 | **接觸器狀態回饋** | 輸入 | 1 | **41** | 3.3V | V | **必須隔離**，偵測接觸器是否吸合 |
| **環境監控** | DS18B20 | **機箱溫度偵測** | 輸入 | 1 | **18** | 3.3V | V | 需接 4.7k 上拉電阻 |
| **環境監控** | MOSFET模組 | **散熱風扇控制** | 輸出 | 1 | **21** | 24V | V | PWM 控制風扇轉速 |
| **通訊/除錯** | USB | **USB Serial/JTAG** | I/O | 2 | **19, 20** | - | - | 19=D-, 20=D+ (直連 Jetson) |
| **通訊/除錯** | 按鈕 | **Alive Check** | 輸入 | 1 | **0** | - | V | 板載 BOOT 鍵，用於 Log 測試 |

---

## ⚡ 接線邏輯說明 (Wiring Logic)

為了確保安全性與遠端控制的靈活性，請遵循以下接線邏輯：

### 1. 啟動迴路 (Start Loop)
*   **目標**：透過 Web 遠端啟動，或現場按下綠色按鈕啟動。
*   **接法**：ESP32 控制的繼電器 (GPIO 38) 的 **NO (常開) 接點**，需 **並聯 (Parallel)** 接在實體啟動按鈕的兩端。
*   **動作**：ESP32 送出訊號 -> 繼電器吸合 0.5 秒 -> 模擬人手按下 -> 接觸器自鎖通電。

### 2. 停止/斷電迴路 (Stop/Cutoff Loop)
*   **目標**：軟體偵測到異常或按下 Web 斷電鈕時，強制切斷強電。
*   **接法**：ESP32 控制的繼電器 (GPIO 39) 的 **NC (常閉) 接點**，需 **串聯 (Series)** 在接觸器的線圈供電迴路上。
*   **動作**：ESP32 送出訊號 -> 繼電器斷開 -> 接觸器線圈失電 -> 系統跳脫。

### 3. 狀態回饋 (Feedback)
*   **重要**：因為 ESP32 是 3.3V 邏輯，**絕對不可**直接將接觸器的 24V/110V 輔助接點接到 GPIO。
*   **接法**：使用 **光耦合隔離模組 (Optocoupler)** 或 **24V轉3.3V 模組**。

---

## 🖥️ Web 儀表板 (Dashboard)

系統啟動後，請連接 WiFi 並訪問：
`http://192.168.2.124`

### 功能區塊
1.  **Monitor (左側)**: 監控停止按鈕、接觸器狀態、機箱溫度。
2.  **Control (中間)**: 遠端執行啟動、斷電、伺服始能切換。
3.  **OTA (中間)**: 填入 `.bin` 連結進行無線更新。
4.  **Motors (下方)**: 7 軸馬達獨立控制卡片，顯示運轉狀態。

---

## 🚀 開發與燒錄 (Development)

本專案使用 ESP-IDF v5.4 開發。

**編譯環境設定:**
```bash
idf.py set-target esp32s3
idf.py menuconfig
# 1. Flash size: 16MB
# 2. PSRAM: Octal Mode (關鍵!)
# 3. Partition Table: Factory app, two OTA definitions
```
**編譯與燒錄:**
``bash
idf.py build
idf.py -p (YOUR_PORT) flash monitor
```

⚠️ 注意事項
1.  Octal PSRAM: 本專案針對 N16R8 模組配置，GPIO 33, 34, 35, 36, 37 不可作為普通 GPIO 使用。
2.  安全性: 軟體停止僅為輔助功能，工業現場必須保留硬體急停 (E-Stop) 按鈕，並直接串聯於主電源迴路。